{{ template "default-state.yaml" }}
---
{{ template "btc-eth-big-pool-state.yaml" }}
---
type: state
genesis:
  app_state:
    mayachain:
      mayanames:
        - name: dx
          expire_block_height: "100000000"
          owner: "{{ addr_maya_cat }}"
          preferred_asset: "MAYA.CACAO"
          aliases:
            - chain: "CACAO"
              address: {{ addr_maya_cat }}
            - chain: "MAYA"
              address: {{ addr_maya_cat }}
            - chain: "THOR"
              address: "thor1rr6rahhd4sy76a7rdxkjaen2q4k4pw2g06w7qp"
      affiliate_collectors:
        - owner_address: {{ addr_maya_cat }}
          cacao_amount: "${AFFCOLL_BALANCE=112626790971391}"
      affiliate_collector_module: "${AFFCOLL_BALANCE}"
---
type: create-blocks
count: 1
---
########################################################################################
# Check MAYANames's settings
########################################################################################
type: check
endpoint: http://localhost:1317/mayachain/mayaname/dx
asserts:
  - .name == "dx"
  - .expire_block_height == 100000000
  - .owner == "{{ addr_maya_cat }}"
  - .preferred_asset == "MAYA.CACAO"
  - .affiliate_collector_cacao == "${AFFCOLL_BALANCE}"
  - .aliases[0].chain == "CACAO"
  - .aliases[0].address == "{{ addr_maya_cat }}"
  - .aliases[1].chain == "MAYA"
  - .aliases[1].address == "{{ addr_maya_cat }}"
  - .aliases[2].chain == "THOR"
  - .aliases[2].address == "thor1rr6rahhd4sy76a7rdxkjaen2q4k4pw2g06w7qp"
---
# save 'dx' (addr_maya_cat) cacao balance
type: check
endpoint: http://localhost:1317/cosmos/bank/v1beta1/balances/{{ addr_maya_cat }}
asserts:
  - .balances[]|select(.denom=="cacao")|.amount|tonumber == ${CAT_BALANCE=2500000000000000}
---
########################################################################################
# swap
########################################################################################
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "${SWAP_AMT=1000000000000}"
    asset: "cacao"
memo: "=:BTC.BTC:{{ addr_btc_fox }}::dx:${BPS=30}"
---
type: create-blocks
count: 2 # main swap + affiliate fee swap
---
# affiliate collector should be cleared
type: check
endpoint: http://localhost:1317/mayachain/mayaname/dx
asserts:
  - .affiliate_collector_cacao|tonumber == 0
---
# previous affiliate collector balance should be added to 'dx' (addr_maya_cat)
type: check
endpoint: http://localhost:1317/cosmos/bank/v1beta1/balances/{{ addr_maya_cat }}
asserts:
  - (${CAT_BALANCE}+${AFFCOLL_BALANCE}+${SWAP_AMT}*${BPS}/10000) - (.balances[]|select(.denom=="cacao")|.amount|tonumber) < (.balances[]|select(.denom=="cacao")|.amount|tonumber) * 0.001 # 10 bps tolerance
