type: env
key: TRADE_ACCOUNTS_SLIP_MIN_BPS
value: "50"
---
# set synth multiplier to 1x for accurate comparison against synth swaps
type: env
key: VIRTUAL_MULT_SYNTHS_BASIS_POINTS
value: "10000"
---
{{ template "5-validators-btc-eth-pool-state.yaml" }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/pools
asserts:
  - .|length == 3
---
# TODO: Remove this after New Mimir MR merge
type: tx-mimir
signer: {{ addr_maya_dog }}
key: TradeAccountsEnabled
value: 1
# TODO: Uncomment this after New Mimir MR merge
#
# ---
# type: tx-mimir
# signer: {{ addr_maya_cat }}
# key: TradeAccountsEnabled
# value: 1
# ---
# type: tx-mimir
# signer: {{ addr_maya_pig }}
# key: TradeAccountsEnabled
# value: 1
# ---
# type: tx-mimir
# signer: {{ addr_maya_fox }}
# key: TradeAccountsEnabled
# value: 1
# ---
# type: tx-mimir
# signer: {{ addr_maya_goat }}
# key: TradeAccountsEnabled
# value: 1
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/mimir
asserts:
  - .TRADEACCOUNTSENABLED == 1
---
########################################################################################
# deposit btc
########################################################################################
type: tx-observed-in
signer: {{ addr_maya_cat }}
txs:
  - tx:
      id: "{{ observe_txid 1 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000" # .1 BTC
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "trade+:{{ addr_maya_fox }}"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
---
type: tx-observed-in
signer: {{ addr_maya_pig }}
txs:
  - tx:
      id: "{{ observe_txid 1 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000" # .1 BTC
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "trade+:{{ addr_maya_fox }}"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
---
type: tx-observed-in
signer: {{ addr_maya_fox }}
txs:
  - tx:
      id: "{{ observe_txid 1 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000" # .1 BTC
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "trade+:{{ addr_maya_fox }}"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
---
type: tx-observed-in
signer: {{ addr_maya_goat }}
txs:
  - tx:
      id: "{{ observe_txid 1 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000" # .1 BTC
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "trade+:{{ addr_maya_fox }}"
    block_height: 1
    finalise_height: 1
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 10000000
  - .depth|tonumber == 10000000
---
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 1
  - .[0].asset == "BTC~BTC"
  - .[0].units|tonumber == 10000000
  - .[0].owner == "{{ addr_maya_fox }}"
---
# Swap trade asset to trade asset, quote should match actual
type: check
endpoint: http://localhost:1317/mayachain/quote/swap
params:
  from_asset: "BTC~BTC"
  to_asset: "ETH~ETH"
  destination: {{ addr_maya_fox }}
  amount: ${SWAP_IN=5000000}
asserts:
  - .expected_amount_out == "${SWAP_OUT=41483443}"
  - .fees.outbound == "${OUTBOUND_FEE=18338}"
  - .fees.liquidity == "${LIQFEE=4149740}"
  - .fees.total == "${FEES_TOTAL=4168078}"
  - .fees.slippage_bps == 909
  - .fees.total_bps == 912
---
# synth swap should be nearly equivalent
type: check
endpoint: http://localhost:1317/mayachain/quote/swap
params:
  from_asset: "BTC/BTC"
  to_asset: "ETH/ETH"
  destination: {{ addr_maya_fox }}
  amount: ${SWAP_IN}
asserts:
  - .fees.outbound|tonumber == ${OUTBOUND_FEE} + ${OUTFEE_DISCREPANCY=753}
  - .expected_amount_out|tonumber == ${SWAP_OUT} - ${OUTFEE_DISCREPANCY} + ${TODO_OUTBOUND_DISCREPANCY_TO_IVESTIGATE=3902411} # TODO: investigate this discrepancy
  # This discrepancy is because a Trade Asset swap lowers the ETH.ETH BalanceAsset
  # and thus the amount of ETH.ETH corresponding to the 0.2 CACAO native outbound fee,
  # whereas a Synth Asset swap leaves the ETH.ETH BalanceAsset unchanged.
  - .fees.liquidity|tonumber == ${LIQFEE} + ${LIQFEE_DISCREPANCY=-1879563}
  - .fees.total|tonumber == ${FEES_TOTAL} + ${OUTFEE_DISCREPANCY} + ${LIQFEE_DISCREPANCY}
  - .fees.slippage_bps == 476
  - .fees.total_bps == 479
---
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "${SWAP_IN}" # 0.05 BTC
    asset: "BTC~BTC"
memo: "=:ETH~ETH:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
# we swapped 0.05 BTC~BTC to ETH~ETH,
# we should have 0.05 BTC~BTC remaining, and ETH~ETH
---
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 2
  - .[0].asset == "BTC~BTC"
  - .[0].units == "5000000" # 0.05 BTC remaining
  - .[0].owner == "{{ addr_maya_fox }}"
  - .[1].asset == "ETH~ETH"
  - .[1].units == "${SWAP_OUT}" # 0.41 ETH
---
type: check
endpoint: http://localhost:1317/mayachain/tx/details/{{ native_txid -1 }}
asserts:
  - .tx.tx.coins | length == 1
  - .tx.tx.coins[0].amount == "${SWAP_IN}"
  - .actions | length == 1
  - .actions[0].coin.amount == "${SWAP_OUT}"
  - .out_txs | length == 1
  - .out_txs[0].coins | length == 1
  - .out_txs[0].coins[0].amount == "${SWAP_OUT}"
  # Prepare next swap in amount.
  - ${SWAP_OUT} / 2 | floor == ${SWAP_IN_1=20741721}
  - ${SWAP_IN_2=20741722} ==  ${SWAP_OUT} - ${SWAP_IN_1}
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - .|[.end_block_events[]|select(.type? == "fee")] | length == 1
  - .end_block_events[]|select(.type? == "fee").coins == "18338 ETH~ETH"
---
# swap half ETH~ETH to BTC~BTC, quote should match actual
type: check
endpoint: http://localhost:1317/mayachain/quote/swap
params:
  from_asset: "ETH~ETH"
  to_asset: "BTC~BTC"
  destination: {{ addr_maya_fox }}
  amount: ${SWAP_IN_1}
asserts:
  - .expected_amount_out == "2278184"
  - .fees.total_bps == 442
---
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "${SWAP_IN_1}" # 0.2 ETH
    asset: "ETH~ETH"
memo: "=:BTC~BTC:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 2
  - .[0].asset == "BTC~BTC"
  - .[0].units == "7278184"
  - .[0].owner == "{{ addr_maya_fox }}"
  - .[1].asset == "ETH~ETH"
  - .[1].units == "20741722" # 0.2 ETH remaining
---
# stream swap remaining ETH, quote should match actual
type: check
endpoint: http://localhost:1317/mayachain/quote/swap
params:
  from_asset: "ETH~ETH"
  to_asset: "BTC~BTC"
  destination: {{ addr_maya_fox }}
  amount: ${SWAP_IN_2}
  streaming_interval: 1
asserts:
  - .expected_amount_out == "2232000"
  - .fees.total_bps == 116
---
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "${SWAP_IN_2}" # 0.2 ETH
    asset: "ETH~ETH"
memo: "=:BTC~BTC:{{ addr_maya_fox }}:0/1/0"
---
type: create-blocks
count: 1
---
# check for streaming swap
type: check
endpoint: http://localhost:1317/mayachain/swaps/streaming
asserts:
  - .|length == 1 # streaming swap in progress complete
  - .[0].destination == "{{ addr_maya_fox }}"
  - .[0].quantity == 4
  - .[0].source_asset == "ETH~ETH"
  - .[0].target_asset == "BTC~BTC"
  - .[0].deposit == "${SWAP_IN_2}"
---
type: create-blocks
count: 4
---
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 1
  - .[0].asset == "BTC~BTC"
  - .[0].units == "9441213"
  - .[0].owner == "{{ addr_maya_fox }}"
---
########################################################################################
# trade accounts respects slip min bps
########################################################################################
type: check
endpoint: http://localhost:1317/mayachain/quote/swap
params:
  from_asset: "BTC~BTC"
  to_asset: "ETH~ETH"
  destination: {{ addr_maya_fox }}
  amount: 10000
asserts:
  - .expected_amount_out == "78845"
  - .fees.outbound == "19993"
  - .fees.liquidity == "19"
  - .fees.slippage_bps == 1
  - .fees.total_bps == 1683
---
# TODO: Remove this after New Mimir MR!398 merge (https://gitlab.com/mayachain/mayanode/-/merge_requests/398)
# type: tx-mimir
# signer: {{ addr_maya_dog }}
# key: TradeAccountsSlipMinBps
# value: 1000
# TODO: Uncomment this after New Mimir MR!398 merge (https://gitlab.com/mayachain/mayanode/-/merge_requests/398)
#
# type: tx-mimir
# signer: {{ addr_maya_cat }}
# key: "TradeAccountsSlipMinBps"
# value: 1000
# ---
# type: tx-mimir
# signer: {{ addr_maya_pig }}
# key: "TradeAccountsSlipMinBps"
# value: 1000
# ---
# type: tx-mimir
# signer: {{ addr_maya_fox }}
# key: "TradeAccountsSlipMinBps"
# value: 1000
# ---
# type: tx-mimir
# signer: {{ addr_maya_goat }}
# key: "TradeAccountsSlipMinBps"
# value: 1000
# ---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/quote/swap
params:
  from_asset: "BTC~BTC"
  to_asset: "ETH~ETH"
  destination: {{ addr_maya_fox }}
  amount: 10000
asserts:
  - .expected_amount_out == "78845"
  - .fees.slippage_bps == 1
  - .fees.total_bps == 1683
---
########################################################################################
# try obtaining MAYA.BTC with EnabledDerivedAssets 0
########################################################################################
type: check
endpoint: http://localhost:1317/bank/balances/{{ addr_maya_fox }}
asserts:
  - .result | length == 2
  - .result[0].denom == "cacao"
  - .result[1].denom == "maya"
---
  # Confirming the sequence before two MsgMimirs (per signer) in the same block.
type: check
endpoint: http://localhost:1317/auth/accounts/{{ addr_maya_cat }}
asserts:
  - .result.value.sequence == "1"
---
type: check
endpoint: http://localhost:1317/auth/accounts/{{ addr_maya_pig }}
asserts:
  - .result.value.sequence == "1"
---
type: check
endpoint: http://localhost:1317/auth/accounts/{{ addr_maya_fox }}
asserts:
  - .result.value.sequence == "4"
---
type: check
endpoint: http://localhost:1317/auth/accounts/{{ addr_maya_goat }}
asserts:
  - .result.value.sequence == "1"
---
# TODO: Remove this after New Mimir MR!398 merge (https://gitlab.com/mayachain/mayanode/-/merge_requests/398)
# type: tx-mimir
# signer: {{ addr_maya_dog }}
# key: EnableDerivedAssets
# value: 0
# TODO: Uncomment this after New Mimir MR!398 merge (https://gitlab.com/mayachain/mayanode/-/merge_requests/398)
#
# type: tx-mimir
# signer: {{ addr_maya_cat }}
# key: EnableDerivedAssets
# value: 0
# sequence: 3
# ---
# type: tx-mimir
# signer: {{ addr_maya_pig }}
# key: EnableDerivedAssets
# value: 0
# sequence: 3
# ---
# type: tx-mimir
# signer: {{ addr_maya_fox }}
# key: EnableDerivedAssets
# value: 0
# sequence: 6
# ---
# type: tx-mimir
# signer: {{ addr_maya_goat }}
# key: EnableDerivedAssets
# value: 0
# sequence: 3
# ---
# TODO: Uncomment this after Derived Assets implemented
#
# type: tx-mimir
# signer: {{ addr_maya_cat }}
# key: DerivedDepthBasisPts
# value: 10000
# sequence: 4
# ---
# type: tx-mimir
# signer: {{ addr_maya_pig }}
# key: DerivedDepthBasisPts
# value: 10000
# sequence: 4
# ---
# type: tx-mimir
# signer: {{ addr_maya_fox }}
# key: DerivedDepthBasisPts
# value: 10000
# sequence: 7
# ---
# type: tx-mimir
# signer: {{ addr_maya_goat }}
# key: DerivedDepthBasisPts
# value: 10000
# sequence: 4
# ---
type: create-blocks
count: 2 # One block to set the Mimirs by the end, one to spawn the THOR.BTC pool at the beginning.
---
# Confirm the Mimir values
type: check
endpoint: http://localhost:1317/mayachain/mimir
asserts:
  # - .["DerivedDepthBasisPts" | ascii_upcase] == 10000
  # - .["EnableDerivedAssets" | ascii_upcase] == 0
  # - .["TradeAccountsSlipMinBps" | ascii_upcase] == 1000
  - .["TradeAccountsEnabled" | ascii_upcase] == 1
---
# Confirm that the MAYA.BTC pool exists.
# type: check
# endpoint: http://localhost:1317/mayachain/dpool/MAYA.BTC
# asserts:
#   - .asset == "MAYA.BTC"
#   - .status == "Available"
#   - .balance_asset | tonumber > 0
#   - .balance_cacao | tonumber > 0
# ---
# type: tx-deposit
# signer: {{ addr_maya_fox }}
# coins:
#   - amount: "1000000" # 0.01 BTC
#     asset: "BTC~BTC"
# memo: "=:MAYA~BTC:{{ addr_maya_fox }}"
# ---
# type: create-blocks
# count: 1
# ---
# type: check
# endpoint: http://localhost:1317/mayachain/block
# asserts:
#   - .|[..|select(.type? == "refund")] | length == 1
#   - ..|select(.type? == "refund").reason | contains("swapping to a trade asset of a native coin is not allowed")
# ---
########################################################################################
# swap to CACAO (for instance if there were an arbitrage opportunity)
########################################################################################
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 1
  - .[0].asset == "BTC~BTC"
  - .[0].units == "${INITIAL_UNITS=9441213}"
  - .[0].owner == "{{ addr_maya_fox }}"
---
type: check
endpoint: http://localhost:1317/bank/balances/{{ addr_maya_fox }}
asserts:
  - .result | length == 2
  - .result[0].denom == "cacao"
  - .result[0].amount == "${INITIAL_CACAO=2494000000000}"
---
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "1000000" # 0.01 BTC
    asset: "BTC~BTC"
memo: "=:MAYA.CACAO:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 1
  - .[0].asset == "BTC~BTC"
  - .[0].units|tonumber < ${INITIAL_UNITS}
  - .[0].owner == "{{ addr_maya_fox }}"
---
type: check
endpoint: http://localhost:1317/bank/balances/{{ addr_maya_fox }}
asserts:
  - .result | length == 2
  - .result[0].denom == "cacao"
  - .result[0].amount|tonumber > ${INITIAL_CACAO} # Swap to CACAO succeeds.
---
########################################################################################
# swap from CACAO
########################################################################################
type: check
endpoint: http://localhost:1317/bank/balances/{{ addr_maya_fox }}
asserts:
  - .result | length == 2
  - .result[0].denom == "cacao"
  - .result[0].amount == "${INITIAL_CACAO=3459560812590}"
---
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 1
  - .[0].asset == "BTC~BTC"
  - .[0].units == "${INITIAL_UNITS=8441213}"
  - .[0].owner == "{{ addr_maya_fox }}"
---
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "1000000000000"
    asset: "MAYA.CACAO"
memo: "=:BTC~BTC:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/bank/balances/{{ addr_maya_fox }}
asserts:
  - .result | length == 2
  - .result[0].denom == "cacao"
  - .result[0].amount|tonumber < ${INITIAL_CACAO} - ${NATIVE_TX_FEE_CACAO=2000000000}
---
type: check
endpoint: http://localhost:1317/mayachain/trade/account/{{ addr_maya_fox }}
asserts:
  - .|length == 1
  - .[0].asset == "BTC~BTC"
  - .[0].units|tonumber > ${INITIAL_UNITS} # Swap from CACAO succeeds.
  - .[0].owner == "{{ addr_maya_fox }}"
---
########################################################################################
# try to swap trade asset to trade asset of native asset (MAYA.MAYA): 
# swap BTC~BTC -> MAYA~MAYA
########################################################################################
# Confirm that the MAYA.MAYA pool exists.
type: check
endpoint: http://localhost:1317/mayachain/pool/MAYA.MAYA
asserts:
  - .asset == "MAYA.MAYA"
  - .status == "Available"
  - .balance_asset | tonumber > 0
  - .balance_cacao | tonumber > 0
---
# swap should fail
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "1000000" # 0.01 BTC
    asset: "BTC~BTC"
memo: "=:MAYA~MAYA:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - .|[..|select(.type? == "refund")] | length == 1
  - .|..|select(.type? == "refund").reason | contains("swapping to a trade asset of a native coin is not allowed")
