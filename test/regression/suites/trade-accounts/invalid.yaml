{{ template "default-state.yaml" }}
---
{{ template "btc-eth-big-pool-state.yaml" }}
---
type: state
genesis:
  app_state:
    auth:
      accounts:
        - "@type": /cosmos.auth.v1beta1.BaseAccount
          address: {{ addr_maya_pig }}
          pub_key: null
          account_number: "9"
          sequence: "0"
    bank:
      balances:
        - address: {{ addr_maya_pig }}
          coins:
            - denom: cacao
              amount: "2500000000000"
    mayachain:
      mimirs:
        - key: PREFERREDASSETOUTBOUNDFEEMULTIPLIER
          value: "5"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/pools
asserts:
  - .|length == 2
---
type: tx-mimir
key: TradeAccountsEnabled
value: 1
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
type: tx-mimir
key: TradeAccountsDepositEnabled
value: 1
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
########################################################################################
# deposit with missing target address
########################################################################################
type: tx-observed-in
signer: {{ addr_maya_dog }}
txs:
- tx:
    id: '{{ observe_txid 1 }}'
    chain: BTC
    from_address: {{ addr_btc_fox }}
    to_address: {{ addr_btc_dog }}
    coins:
      - amount: "10000000" # .1 BTC
        asset: "BTC.BTC"
        decimals: 8
    gas:
      - amount: "10000"
        asset: "BTC.BTC"
    memo: "trade+:"
  block_height: 1
  finalise_height: 1
  observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: tx-observed-out
signer: {{ addr_maya_dog }}
txs:
  - tx:
      id: "{{ observe_txid 2 }}"
      chain: "BTC"
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_fox }}
      coins:
        - amount: "9986000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10500"
          asset: "BTC.BTC"
      memo: "REFUND:{{ observe_txid 1 }}"
    block_height: 3
    finalise_height: 3
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/trade/accounts/BTC~BTC
asserts:
- .|length == 0
---
########################################################################################
# deposit with wrong chain address
########################################################################################
type: tx-observed-in
signer: {{ addr_maya_dog }}
txs:
- tx:
    id: '{{ observe_txid 3 }}'
    chain: BTC
    from_address: {{ addr_btc_fox }}
    to_address: {{ addr_btc_dog }}
    coins:
      - amount: "10000000" # .1 BTC
        asset: "BTC.BTC"
        decimals: 8
    gas:
      - amount: "10000"
        asset: "BTC.BTC"
    memo: "trade+:{{ addr_thor_dog }}"
  block_height: 5
  finalise_height: 5
  observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: tx-observed-out
signer: {{ addr_maya_dog }}
txs:
  - tx:
      id: "{{ observe_txid 4 }}"
      chain: "BTC"
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_fox }}
      coins:
        - amount: "9986000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10500"
          asset: "BTC.BTC"
      memo: "REFUND:{{ observe_txid 3 }}"
    block_height: 6
    finalise_height: 6
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/trade/accounts/BTC~BTC
asserts:
- .|length == 0
---
########################################################################################
# deposit from two different accounts, withdraw one, sanity check others
########################################################################################
type: tx-observed-in
signer: {{ addr_maya_dog }}
txs:
- tx:
    id: '{{ observe_txid 5 }}'
    chain: BTC
    from_address: {{ addr_btc_fox }}
    to_address: {{ addr_btc_dog }}
    coins:
      - amount: "100000000" # 1 BTC
        asset: "BTC.BTC"
        decimals: 8
    gas:
      - amount: "10000"
        asset: "BTC.BTC"
    memo: "trade+:{{ addr_maya_fox }}"
  block_height: 7
  finalise_height: 7
  observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: tx-observed-in
signer: {{ addr_maya_dog }}
txs:
- tx:
    id: '{{ observe_txid 6 }}'
    chain: BTC
    from_address: {{ addr_btc_pig }}
    to_address: {{ addr_btc_dog }}
    coins:
      - amount: "50000000" # 0.5 BTC
        asset: "BTC.BTC"
        decimals: 8
    gas:
      - amount: "10000"
        asset: "BTC.BTC"
    memo: "trade+:{{ addr_maya_pig }}"
  block_height: 8
  finalise_height: 8
  observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: tx-deposit
signer: {{ addr_maya_fox }}
coins:
  - amount: "100000000"
    asset: "BTC~BTC"
memo: "trade-:{{ addr_btc_fox }}"
---
type: create-blocks
count: 1
---
type: tx-observed-out
signer: {{ addr_maya_dog }}
txs:
  - tx:
      id: "{{ observe_txid 7 }}"
      chain: "BTC"
      from_address: {{ addr_btc_dog }}
      to_address: {{ addr_btc_fox }}
      coins:
        - amount: "99986000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10500"
          asset: "BTC.BTC"
      memo: "OUT:{{ native_txid -1 }}"
    block_height: 9
    finalise_height: 9
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/queue/outbound
asserts:
  - .|length == 0
---
type: check
endpoint: http://localhost:1317/mayachain/trade/accounts/BTC~BTC
asserts:
- .|length == 1
- .[0].units|tonumber == 50000000
- .[0].owner == "{{ addr_maya_pig }}"
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
- .units|tonumber == 50000000
- .depth|tonumber == 50000000
---
########################################################################################
# Check with TradeAccountsEnabled Mimir disabled and TradeAccountsDepositEnabled enabled
########################################################################################
type: tx-mimir
key: TradeAccountsEnabled
value: 0
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
type: tx-mimir
key: TradeAccountsDepositEnabled
value: 1
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
########################################################################################
# TradeAccountsEnabled is disabled - deposit btc - should fail
########################################################################################
type: tx-observed-in
signer: {{ addr_maya_dog }}
txs:
  - tx:
      id: "{{ observe_txid 8 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "trade+:{{ addr_maya_fox }}"
    block_height: 10
    finalise_height: 10
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.txs[].result.events[]|select(.type=="refund")]|length == 1'
  - .txs[].result.events[]|select(.type=="refund").code == "100"
  - .txs[].result.events[]|select(.type=="refund").reason| contains("trade accounts are disabled")
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 50000000 # unchanged
  - .depth|tonumber == 50000000 # unchanged
---
type: tx-observed-out
signer: {{ addr_maya_dog }}
txs:
- tx:
    id: '{{ observe_txid 9 }}'
    chain: BTC
    from_address: {{ addr_btc_dog }}
    to_address: {{ addr_btc_fox }}
    coins:
      - amount: "9986001"
        asset: "BTC.BTC"
        decimals: 8
    gas:
      - amount: "10500"
        asset: "BTC.BTC"
    memo: "REFUND:{{ observe_txid 8 }}"
  block_height: 11
  finalise_height: 11
  observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/queue/outbound
asserts:
  - .|length == 0
---
########################################################################################
# TradeAccountsEnabled is disabled - swap btc -> trade asset - should fail
########################################################################################
type: tx-observed-in
signer: {{ addr_maya_dog }}
txs:
  - tx:
      id: "{{ observe_txid 10 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "=:BTC~BTC:{{ addr_maya_pig }}"
    block_height: 12
    finalise_height: 12
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.end_block_events[]|select(.type=="refund")]|length == 1'
  - '.end_block_events[]|select(.type=="refund").code == "108"'
  - '.end_block_events[]|select(.type=="refund").memo == "=:BTC~BTC:tmaya1qk8c8sfrmfm0tkncs0zxeutc8v5mx3pjjcq6rv"'
  - '.end_block_events[]|select(.type=="refund").reason == "swaps from L1 to trade asset incur slip, use trade+"'
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 50000000 # unchanged
  - .depth|tonumber == 50000000 # unchanged
---
type: tx-observed-out
signer: {{ addr_maya_dog }}
txs:
- tx:
    id: '{{ observe_txid 11 }}'
    chain: BTC
    from_address: {{ addr_btc_dog }}
    to_address: {{ addr_btc_fox }}
    coins:
      - amount: "9986001"
        asset: "BTC.BTC"
        decimals: 8
    gas:
      - amount: "10500"
        asset: "BTC.BTC"
    memo: "REFUND:{{ observe_txid 10 }}"
  block_height: 13
  finalise_height: 13
  observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/queue/outbound
asserts:
  - .|length == 0
---
########################################################################################
# TradeAccountsEnabled is disabled - swap trade_asset -> cacao - should fail
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "1000000" # 0.01 BTC
    asset: "BTC~BTC"
memo: "=:MAYA.CACAO:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.end_block_events[]|select(.type=="refund")]|length == 1'
  - '.end_block_events[]|select(.type=="refund").code == "108"'
  - '.end_block_events[]|select(.type=="refund").memo == "=:MAYA.CACAO:{{ addr_maya_fox }}"'
  - '.end_block_events[]|select(.type=="refund").reason == "trade accounts are disabled"'
---
########################################################################################
# TradeAccountsEnabled is disabled - swap cacao -> trade_asset - should fail
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "1000000000000"
    asset: "MAYA.CACAO"
memo: "=:BTC~BTC:{{ addr_maya_pig }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.end_block_events[]|select(.type=="refund")]|length == 1'
  - '.end_block_events[]|select(.type=="refund").code == "108"'
  - '.end_block_events[]|select(.type=="refund").memo == "=:BTC~BTC:{{ addr_maya_pig }}"'
  - '.end_block_events[]|select(.type=="refund").reason == "trade accounts are disabled"'
---
########################################################################################
# TradeAccountsEnabled is disabled - withdraw btc - should fail
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "100000"
    asset: "BTC~BTC"
memo: "trade-:{{ addr_btc_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.txs[].result.events[]|select(.type=="refund")]|length == 1'
  - .txs[].result.events[]|select(.type=="refund").code == "1"
  - .txs[].result.events[]|select(.type=="refund").memo == "trade-:{{ addr_btc_fox }}"
  - .txs[].result.events[]|select(.type=="refund").reason| contains("trade accounts are disabled")
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 50000000 # unchanged
  - .depth|tonumber == 50000000 # unchanged
---
########################################################################################
# Check with TradeAccountsEnabled Mimir enabled and TradeAccountsDepositEnabled disabled
# withdraw & swap trade_asset -> cacao - should succeed
########################################################################################
type: tx-mimir
key: TradeAccountsEnabled
value: 1
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
type: tx-mimir
key: TradeAccountsDepositEnabled
value: 0
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
########################################################################################
# TradeAccountsDepositEnabled is disabled - deposit btc - should fail
########################################################################################
type: tx-observed-in
signer: {{ addr_maya_dog }}
txs:
  - tx:
      id: "{{ observe_txid 12 }}"
      chain: BTC
      from_address: {{ addr_btc_fox }}
      to_address: {{ addr_btc_dog }}
      coins:
        - amount: "10000000"
          asset: "BTC.BTC"
          decimals: 8
      gas:
        - amount: "10000"
          asset: "BTC.BTC"
      memo: "trade+:{{ addr_maya_fox }}"
    block_height: 14
    finalise_height: 14
    observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.txs[].result.events[]|select(.type=="refund")]|length == 1'
  - .txs[].result.events[]|select(.type=="refund").code == "100"
  - .txs[].result.events[]|select(.type=="refund").reason| contains("trade accounts deposits are disabled")
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 50000000 # unchanged
  - .depth|tonumber == 50000000 # unchanged
---
type: tx-observed-out
signer: {{ addr_maya_dog }}
txs:
- tx:
    id: '{{ observe_txid 13 }}'
    chain: BTC
    from_address: {{ addr_btc_dog }}
    to_address: {{ addr_btc_fox }}
    coins:
      - amount: "9986001"
        asset: "BTC.BTC"
        decimals: 8
    gas:
      - amount: "10500"
        asset: "BTC.BTC"
    memo: "REFUND:{{ observe_txid 12 }}"
  block_height: 15
  finalise_height: 15
  observed_pub_key: {{ pubkey_dog }}
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/queue/outbound
asserts:
  - .|length == 0
---
########################################################################################
# TradeAccountsDepositEnabled is disabled - swap trade_asset -> cacao - should succeed
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "300000" # 0.01 BTC
    asset: "BTC~BTC"
memo: "=:MAYA.CACAO:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 49700000 # amount changed - swap succeeded
  - .depth|tonumber == 49700000 # amount changed - swap succeeded
---
########################################################################################
# TradeAccountsDepositEnabled is disabled - swap cacao -> trade_asset - should fail
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "1000000000000"
    asset: "MAYA.CACAO"
memo: "=:BTC~BTC:{{ addr_maya_pig }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.end_block_events[]|select(.type=="refund")]|length == 1'
  - '.end_block_events[]|select(.type=="refund").code == "108"'
  - '.end_block_events[]|select(.type=="refund").memo == "=:BTC~BTC:{{ addr_maya_pig }}"'
  - '.end_block_events[]|select(.type=="refund").reason == "trade accounts deposits are disabled"'
---
########################################################################################
# TradeAccountsDepositEnabled is disabled - withdraw btc - should succeed
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "300000"
    asset: "BTC~BTC"
memo: "trade-:{{ addr_btc_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 49400000 # amount changed - withdraw succeeded
  - .depth|tonumber == 49400000 # amount changed - withdraw succeeded
---
########################################################################################
# Check with TradeAccountsEnabled and TradeAccountsDepositEnabled enabled 
# but TradeAccountsWithdrawEnabled disabled
# withdraw & swap trade_asset -> cacao - should succeed
########################################################################################
type: tx-mimir
key: TradeAccountsDepositEnabled
value: 1
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
type: tx-mimir
key: TradeAccountsWithdrawEnabled
value: 0
signer: {{ addr_maya_dog }}
---
type: create-blocks
count: 1
---
########################################################################################
# TradeAccountsWithdrawEnabled is disabled - swap trade_asset -> cacao - should fail
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "300000" # 0.01 BTC
    asset: "BTC~BTC"
memo: "=:MAYA.CACAO:{{ addr_maya_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.end_block_events[]|select(.type=="refund")]|length == 1'
  - '.end_block_events[]|select(.type=="refund").reason == "trade accounts withdrawals are disabled"'
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 49400000 # amount unchanged - swap failed
  - .depth|tonumber == 49400000 # amount unchanged - swap failed
---
########################################################################################
# TradeAccountsWithdrawEnabled is disabled - withdraw btc - should fail
########################################################################################
type: tx-deposit
signer: {{ addr_maya_pig }}
coins:
  - amount: "300000"
    asset: "BTC~BTC"
memo: "trade-:{{ addr_btc_fox }}"
---
type: create-blocks
count: 1
---
type: check
endpoint: http://localhost:1317/mayachain/block
asserts:
  - '[.txs[].result.events[]|select(.type=="refund")]|length == 1'
  - '.txs[].result.events[]|select(.type=="refund").reason == "trade accounts withdrawals are disabled"'
---
type: check
endpoint: http://localhost:1317/mayachain/trade/unit/BTC~BTC
asserts:
  - .asset == "BTC~BTC"
  - .units|tonumber == 49400000 # amount unchanged - withdraw failed
  - .depth|tonumber == 49400000 # amount unchanged - withdraw failed
